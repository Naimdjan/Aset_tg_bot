const express = require("express");
const axios = require("axios");

const app = express();
app.use(express.json());

const BOT_TOKEN = process.env.BOT_TOKEN;
if (!BOT_TOKEN) {
  console.error("âŒ BOT_TOKEN not found in environment variables");
}

const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}`;

// âœ… health endpoint
app.get("/health", (req, res) => {
  res.status(200).json({ status: "ok" });
});

// âœ… Telegram webhook
app.post("/telegram/webhook", async (req, res) => {
  res.sendStatus(200); // Ð’ÐÐ–ÐÐž: ÑÑ€Ð°Ð·Ñƒ Ð¾Ñ‚Ð²ÐµÑ‡Ð°ÐµÐ¼ Telegram

  try {
    const update = req.body;

    if (update.message && update.message.text) {
      const chatId = update.message.chat.id;
      const text = update.message.text;

      if (text === "/start") {
        await axios.post(`${TELEGRAM_API}/sendMessage`, {
          chat_id: chatId,
          text: "ðŸ‘‹ ÐŸÑ€Ð¸Ð²ÐµÑ‚! Ð“Ð»Ð°Ð²Ð½Ð¾Ðµ Ð¼ÐµÐ½ÑŽ Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¾.",
          reply_markup: {
            keyboard: [
              [{ text: "ðŸ“ ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ°" }],
              [{ text: "âŒ ÐžÑ‚Ð¼ÐµÐ½Ð°" }]
            ],
            resize_keyboard: true
          }
        });
        return;
      }

      if (text === "ðŸ“ ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ°") {
        await axios.post(`${TELEGRAM_API}/sendMessage`, {
          chat_id: chatId,
          text: "ðŸ“ž Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:"
        });
        return;
      }

      if (text === "âŒ ÐžÑ‚Ð¼ÐµÐ½Ð°") {
        await axios.post(`${TELEGRAM_API}/sendMessage`, {
          chat_id: chatId,
          text: "âŒ ÐžÑ‚Ð¼ÐµÐ½ÐµÐ½Ð¾."
        });
        return;
      }

      // Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
      await axios.post(`${TELEGRAM_API}/sendMessage`, {
        chat_id: chatId,
        text: `âœ… ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾: ${text}`
      });
    }

  } catch (error) {
    console.error("Webhook error:", error.response?.data || error.message);
  }
});

const PORT = process.env.PORT || 10000;
app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on port ${PORT}`);
});
